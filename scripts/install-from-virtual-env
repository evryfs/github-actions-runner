#!/bin/bash

set -e

export CHECKOUT_PATH=/virtual-environments
export METADATA_FILE=/metadatafile
export HELPER_SCRIPTS="${CHECKOUT_PATH}"/images/linux/scripts/helpers
export SCRIPT_PATH="${CHECKOUT_PATH}"/images/linux/scripts/installers
export INSTALLER_SCRIPT_FOLDER="${CHECKOUT_PATH}"/images/linux/scripts/installers
git config --global advice.detachedHead false

if [ ! -d /virtual-environments ]; then
    git clone --branch "${VIRTUAL_ENVIRONMENT_VERSION}" --single-branch https://github.com/actions/virtual-environments "${CHECKOUT_PATH}"
fi

chmod a+x ${HELPER_SCRIPTS}/*sh
export PATH=${PATH}:${HELPER_SCRIPTS}

if [ ! -L /imagegeneration ]; then
    ln -s "${CHECKOUT_PATH}"/images/linux/scripts imagegeneration
fi

if [ ! -f /etc/apt/trusted.gpg.d/microsoft.gpg ]; then
    chmod +x "${CHECKOUT_PATH}"/images/linux/scripts/base/repos.sh
    "${CHECKOUT_PATH}"/images/linux/scripts/base/repos.sh
fi

if [ ! -f ${INSTALLER_SCRIPT_FOLDER}/toolset.json ]; then
    cp "${CHECKOUT_PATH}"/images/linux/toolsets/toolset-"${UBUNTU_VERSION}".json "${INSTALLER_SCRIPT_FOLDER}"/toolset.json
fi

if [ -z "$1" ]; then
    echo "You have the package you want to install."
    exit 1
fi
SCRIPT="${1}.sh"
if [ ! -f "${SCRIPT_PATH}/${SCRIPT}" ]; then
    echo "Package not available in the virtual environment."
    exit 1
fi

chmod +x ${SCRIPT_PATH}/"${SCRIPT}"
${SCRIPT_PATH}/"${SCRIPT}"

